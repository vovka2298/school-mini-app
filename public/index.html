<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Кабинет преподавателя</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/js/subjects.js"></script>
  <style>
    body{margin:0;background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .header{background:#161b22;padding:16px;display:flex;align-items:center;gap:14px;border-bottom:1px solid #30363d}
    .avatar{width:52px;height:52px;border-radius:50%;border:3px solid #58a6ff;object-fit:cover}
    .user-info h3{margin:0;font-size:19px;font-weight:600}
    .user-info p{margin:4px 0 0;font-size:14px;color:#58a6ff}
    .tabs{display:flex;background:#161b22;border-bottom:1px solid #30363d}
    .tab{flex:1;padding:16px;text-align:center;font-weight:600;cursor:pointer}
    .tab.active{background:#1f6feb;color:white}
    .legend{padding:14px;background:#161b22;display:flex;justify-content:center;gap:24px;font-size:13px;align-items:center}
    .legend-item{display:flex;align-items:center;gap:8px}
    .legend-box{width:16px;height:16px;border-radius:6px}
    .grid{padding:12px;overflow-y:auto;height:calc(100vh - 235px)}
    .week-header{display:flex;margin-left:68px;margin-bottom:8px;font-size:12px;color:#8b949e}
    .day-name{width:88px;text-align:center;flex:none}
    .time-row{display:flex;align-items:center;margin:3px 0}
    .time-label{width:68px;text-align:right;font-size:13px;color:#8b949e;padding-right:12px;flex:none}
    .slots{display:flex;flex:1}
    .slot{width:80px;height:56px;margin:0 4px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;font-weight:bold;cursor:pointer;transition:all .2s;flex:none;box-sizing:border-box;overflow:hidden}
    .state-0{background:#21262d;color:#8b949e}
    .state-1{background:#238636;color:white}
    .state-2{background:#da3633;color:white}
    .slot-time{font-size:9px;opacity:0.8;margin-bottom:3px}
    .slot-text{line-height:1.1}
    .subjects h2{font-size:20px;margin-bottom:10px}
    .subjects p{font-size:14px;color:#8b949e;margin-bottom:20px}
    .subjects-block{background:#161b22;border-radius:12px;padding:20px}
    .checkbox-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
    .checkbox-item{display:flex;align-items:center;gap:12px;font-size:15px;cursor:pointer}
    .checkbox-item input{transform:scale(1.4)}
    .gender label{font-size:15px}
    .save-btn{background:#1f6feb;color:white;border:none;padding:16px;border-radius:12px;width:100%;font-size:16px;font-weight:600;cursor:pointer}
    .save-btn:hover{background:#1565c0}
  </style>
</head>
<body>
  <div class="header">
    <img class="avatar" id="avatar" src="" alt="">
    <div class="user-info">
      <h3 id="userName">Загрузка...</h3>
      <p>Кабинет преподавателя</p>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('schedule')">Расписание</div>
    <div class="tab" onclick="showTab('bookings')">Мои заявки</div>
    <div class="tab" onclick="showTab('subjects')">Предметы</div>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#21262d"></div>Не работаю</div>
    <div class="legend-item"><div class="legend-box" style="background:#238636"></div>Свободен</div>
    <div class="legend-item"><div class="legend-box" style="background:#da3633"></div>Занят</div>
  </div>

  <div class="grid" id="content"></div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const DAYS = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
    const FULL_DAYS = ['Понедельник','Вторник','Среда','Четверг','Пятница','Суббота','Воскресенье'];
    const TIMES = [];
    for(let h=8; h<=22; h++){
      TIMES.push(`${h.toString().padStart(2,'0')}:00`);
      if(h<22) TIMES.push(`${h.toString().padStart(2,'0')}:30`);
    }
    const TEXTS = ['Не работаю', 'Свободен', 'Занят'];

    let user = null;
    let schedule = {};

    function getHeaders() {
      return { 'x-telegram-webapp-init-data': Telegram.WebApp.initData || '' };
    }

    async function init() {
      try {
        const uRes = await fetch('/api/user', { headers: getHeaders() });
        if (!uRes.ok) throw new Error('User: ' + uRes.status);
        const u = await uRes.json();
        if (!u.role) {
          Telegram.WebApp.showAlert('Ожидает одобрения админа');
          return setTimeout(init, 5000);
        }

        user = u;
        document.getElementById('userName').textContent = u.name;

        const sRes = await fetch('/api/schedules', { headers: getHeaders() });
        if (!sRes.ok) throw new Error('Schedules: ' + sRes.status);
        const s = await sRes.json();
        schedule = s[u.tgId] || {};

        showTab('schedule'); // АВТО-ОТКРЫТИЕ РАСПИСАНИЯ
      } catch (e) {
        console.error(e);
        Telegram.WebApp.showAlert('Ошибка загрузки данных');
        setTimeout(init, 3000);
      }
    }

    const content = document.getElementById('content');

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'schedule') {
        renderSchedule();
      } else if (tab === 'bookings') {
        content.innerHTML = '<p style="text-align:center;padding:60px;color:#8b949e">Скоро появятся заявки</p>';
      } else if (tab === 'subjects') {
        content.innerHTML = `
          <div class="subjects">
            <h2>Мои предметы</h2>
            <p>Выберите предметы, которые вы преподаёте</p>
            <div class="subjects-block">
              <div class="checkbox-grid" id="subjectsList"></div>
              <div class="gender">
                <p style="margin:20px 0 10px">Ваш пол</p>
                <label><input type="radio" name="gender" value="Мужской"> Мужской</label>
                <label style="margin-left:20px"><input type="radio" name="gender" value="Женский"> Женский</label>
              </div>
              <button class="save-btn" onclick="saveProfile()">Сохранить изменения</button>
            </div>
          </div>
        `;
        loadProfile(); // из subjects.js
      }
    }

    function renderSchedule() {
      let html = '<div class="week-header"><div></div>';
      DAYS.forEach(d => html += `<div class="day-name">${d}</div>`);
      html += '</div>';

      TIMES.forEach(time => {
        html += `<div class="time-row"><div class="time-label">${time}</div><div class="slots">`;
        DAYS.forEach((_, i) => {
          const day = FULL_DAYS[i];
          const state = (schedule[day]?.[time]) ?? 0;
          html += `<div class="slot state-${state}" onclick="toggle('${day}','${time}',this)">
            <div class="slot-time">${time}</div>
            <div class="slot-text">${TEXTS[state]}</div>
          </div>`;
        });
        html += '</div></div>';
      });
      content.innerHTML = html;
    }

    async function toggle(day, time, el) {
      if (!user) return;

      if (!schedule[day]) schedule[day] = {};
      const curr = schedule[day][time] ?? 0;
      const next = (curr + 1) % 3;
      schedule[day][time] = next;
      el.className = `slot state-${next}`;
      el.querySelector('.slot-text').textContent = TEXTS[next];

      try {
        const res = await fetch(`/api/schedule/${user.tgId}`, {
          method: 'POST',
          headers: { ...getHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ [day]: schedule[day] })
        });
        if (!res.ok) throw new Error();
      } catch (e) {
        Telegram.WebApp.showAlert('Ошибка сохранения');
        schedule[day][time] = curr;
        el.className = `slot state-${curr}`;
        el.querySelector('.slot-text').textContent = TEXTS[curr];
      }
    }

    init();
  </script>
</body>
</html>
