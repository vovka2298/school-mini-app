<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Кабинет преподавателя</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: system-ui, sans-serif;
    }
    
    .header {
      background: #161b22;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid #30363d;
    }
    
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid #58a6ff;
      object-fit: cover;
    }
    
    .tabs {
      display: flex;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }
    
    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
    }
    
    .tab.active {
      background: #1f6feb;
      color: white;
    }
    
    .legend {
      padding: 14px;
      background: #161b22;
      display: flex;
      justify-content: center;
      gap: 24px;
      font-size: 13px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 6px;
    }
    
    .grid {
      padding: 12px;
      overflow-y: auto;
      height: calc(100vh - 235px);
    }
    
    .week-header {
      display: flex;
      margin-left: 68px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #8b949e;
    }
    
    .day-name {
      width: 88px;
      text-align: center;
      flex: none;
    }
    
    .time-row {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    
    .time-label {
      width: 68px;
      text-align: right;
      font-size: 13px;
      color: #8b949e;
      padding-right: 12px;
      flex: none;
    }
    
    .slots {
      display: flex;
      flex: 1;
    }
    
    .slot {
      width: 80px;
      height: 56px;
      margin: 0 4px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }
    
    .state-0 {
      background: #21262d;
      color: #8b949e;
    }
    
    .state-1 {
      background: #238636;
      color: white;
    }
    
    .state-2 {
      background: #da3633;
      color: white;
    }
    
    .slot-time {
      font-size: 9px;
      opacity: 0.8;
      margin-bottom: 3px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
      font-size: 16px;
    }
    
    .error {
      text-align: center;
      padding: 60px 20px;
      color: #da3633;
    }
    
    .retry-btn {
      background: #1f6feb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img class="avatar" id="avatar" src="" alt="">
    <div>
      <h3 id="userName">Загрузка...</h3>
      <p>Кабинет преподавателя</p>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="openTab('schedule')">Расписание</div>
    <div class="tab" onclick="openTab('bookings')">Заявки</div>
    <div class="tab" onclick="openTab('subjects')">Предметы</div>
  </div>
  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#21262d"></div>Не работаю</div>
    <div class="legend-item"><div class="legend-box" style="background:#238636"></div>Свободен</div>
    <div class="legend-item"><div class="legend-box" style="background:#da3633"></div>Занят</div>
  </div>
  
  <div class="grid" id="content">
    <div class="loading">Загрузка расписания...</div>
  </div>

  <script>
    // Инициализация Telegram Web App
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    
    console.log("Telegram Web App инициализирован");
    
    // Константы
    const DAYS = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
    const FULL_DAYS = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
    
    // Генерация времени с 8:00 до 22:00 каждые 30 минут
    const TIMES = [];
    for (let h = 8; h <= 22; h++) {
      TIMES.push(`${h.toString().padStart(2, '0')}:00`);
      if (h < 22) {
        TIMES.push(`${h.toString().padStart(2, '0')}:30`);
      }
    }
    
    const TEXTS = ['Не работаю', 'Свободен', 'Занят'];
    
    // Глобальные переменные
    let mySchedule = {};
    const tgId = "913096324";
    let saveTimeout = null;
    
    // ===== ОСНОВНЫЕ ФУНКЦИИ =====
    
    // Главная функция инициализации
    async function init() {
      console.log("Начало инициализации приложения");
      
      try {
        // Загружаем данные пользователя
        await loadUser();
        
        // ЗАГРУЖАЕМ РАСПИСАНИЕ СРАЗУ
        await loadSchedule();
        
        console.log("Приложение успешно инициализировано");
      } catch (error) {
        console.error("Ошибка инициализации:", error);
        showError("Ошибка загрузки. Проверьте интернет и попробуйте снова.");
      }
    }
    
    // Загрузка данных пользователя
    async function loadUser() {
      try {
        const response = await fetch('/api/user');
        if (!response.ok) throw new Error('Ошибка сервера');
        
        const userData = await response.json();
        document.getElementById('userName').textContent = userData.name || "Преподаватель";
        console.log("Данные пользователя загружены:", userData.name);
      } catch (error) {
        console.error("Ошибка загрузки пользователя:", error);
        document.getElementById('userName').textContent = "Преподаватель";
      }
    }
    
    // Загрузка расписания
    async function loadSchedule() {
      console.log("Загрузка расписания...");
      
      try {
        const response = await fetch('/api/my-schedule');
        
        if (!response.ok) {
          throw new Error('Сервер вернул ошибку: ' + response.status);
        }
        
        const data = await response.json();
        console.log("Расписание получено:", data);
        
        mySchedule = data || {};
        renderSchedule();
        
      } catch (error) {
        console.error("Ошибка загрузки расписания:", error);
        showError("Не удалось загрузить расписание. Попробуйте еще раз.");
      }
    }
    
    // Рендер расписания
    function renderSchedule() {
      console.log("Рендеринг расписания...");
      
      let html = '<div class="week-header"><div></div>';
      
      // Дни недели
      DAYS.forEach(day => {
        html += `<div class="day-name">${day}</div>`;
      });
      
      html += '</div>';
      
      // Временные слоты
      TIMES.forEach(time => {
        html += `
          <div class="time-row">
            <div class="time-label">${time}</div>
            <div class="slots">
        `;
        
        // Ячейки для каждого дня
        DAYS.forEach((_, dayIndex) => {
          const dayName = FULL_DAYS[dayIndex];
          const state = getSlotState(dayName, time);
          const stateText = TEXTS[state];
          
          html += `
            <div class="slot state-${state}" 
                 onclick="toggleSlot('${dayName}', '${time}', this)"
                 title="${dayName} ${time} - ${stateText}">
              <div class="slot-time">${time}</div>
              <div class="slot-text">${stateText}</div>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      document.getElementById('content').innerHTML = html;
      console.log("Расписание отрендерено");
    }
    
    // Получить состояние ячейки
    function getSlotState(day, time) {
      if (!mySchedule[day]) return 0;
      return mySchedule[day][time] || 0;
    }
    
    // Переключение состояния ячейки
    async function toggleSlot(day, time, element) {
      console.log(`Клик: ${day} ${time}`);
      
      // Получаем текущее состояние
      if (!mySchedule[day]) {
        mySchedule[day] = {};
      }
      
      const currentState = mySchedule[day][time] || 0;
      const newState = (currentState + 1) % 3;
      
      // Обновляем в памяти
      mySchedule[day][time] = newState;
      
      // Обновляем UI
      element.className = `slot state-${newState}`;
      element.querySelector('.slot-text').textContent = TEXTS[newState];
      
      // Сохраняем с задержкой
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }
      
      saveTimeout = setTimeout(async () => {
        await saveSchedule();
      }, 300);
    }
    
    // Сохранение расписания на сервер
    async function saveSchedule() {
      console.log("Сохранение расписания...", mySchedule);
      
      try {
        const response = await fetch(`/api/schedule/${tgId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(mySchedule)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка сохранения: ' + response.status);
        }
        
        const result = await response.json();
        console.log("Расписание сохранено:", result);
        
      } catch (error) {
        console.error("Ошибка сохранения расписания:", error);
        Telegram.WebApp.showAlert("Ошибка сохранения. Проверьте подключение.");
      }
    }
    
    // Показать ошибку
    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="error">
          ${message}
          <br>
          <button class="retry-btn" onclick="retryLoad()">Повторить</button>
        </div>
      `;
    }
    
    // Повторная загрузка
    function retryLoad() {
      document.getElementById('content').innerHTML = '<div class="loading">Загрузка...</div>';
      setTimeout(loadSchedule, 500);
    }
    
    // Переключение вкладок
    function openTab(tabName) {
      // Обновляем активную вкладку
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Активируем текущую вкладку
      const tabs = document.querySelectorAll('.tab');
      if (tabName === 'schedule') tabs[0].classList.add('active');
      if (tabName === 'bookings') tabs[1].classList.add('active');
      if (tabName === 'subjects') tabs[2].classList.add('active');
      
      // Загружаем контент
      if (tabName === 'schedule') {
        renderSchedule();
      } else if (tabName === 'bookings') {
        document.getElementById('content').innerHTML = `
          <div class="loading">
            Раздел "Заявки" в разработке
          </div>
        `;
      } else if (tabName === 'subjects') {
        window.location.href = 'subjects.html';
      }
    }
    
    // Проверка состояния сервера
    async function checkServerStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        console.log("Статус сервера:", data);
        return true;
      } catch (error) {
        console.error("Сервер недоступен:", error);
        return false;
      }
    }
    
    // ===== ЗАПУСК ПРИЛОЖЕНИЯ =====
    
    // Ждем полной загрузки DOM
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("DOM загружен, запускаем приложение");
      
      // Проверяем сервер
      const serverOk = await checkServerStatus();
      if (!serverOk) {
        showError("Сервер временно недоступен. Попробуйте позже.");
        return;
      }
      
      // Запускаем инициализацию
      init();
    });
    
    // Также запускаем если страница уже загружена
    if (document.readyState === 'complete') {
      init();
    }
  </script>
</body>
</html>
