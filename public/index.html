<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .header {
      background: #161b22;
      padding: 16px;
      border-bottom: 1px solid #30363d;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid #58a6ff;
      background: #21262d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .refresh-btn {
      background: #238636;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    .refresh-btn:hover {
      background: #2ea043;
    }
    
    .refresh-btn:active {
      transform: scale(0.98);
    }
    
    .tabs {
      display: flex;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }
    
    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }
    
    .tab.active {
      background: #1f6feb;
      color: white;
    }
    
    .legend {
      padding: 14px;
      background: #161b22;
      display: flex;
      justify-content: center;
      gap: 24px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 6px;
    }
    
    .content {
      padding: 12px;
      height: calc(100vh - 250px);
      overflow-y: auto;
      position: relative;
    }
    
    .week-header {
      display: flex;
      margin-left: 68px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #8b949e;
    }
    
    .day-name {
      width: 88px;
      text-align: center;
      flex: none;
    }
    
    .time-row {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    
    .time-label {
      width: 68px;
      text-align: right;
      font-size: 13px;
      color: #8b949e;
      padding-right: 12px;
      flex: none;
    }
    
    .slots {
      display: flex;
      flex: 1;
    }
    
    .slot {
      width: 80px;
      height: 56px;
      margin: 0 4px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
      user-select: none;
    }
    
    .slot:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .state-0 { background: #21262d; color: #8b949e; }
    .state-1 { background: #238636; color: white; }
    .state-2 { background: #da3633; color: white; }
    
    .slot-time {
      font-size: 9px;
      opacity: 0.8;
      margin-bottom: 3px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
      font-size: 16px;
    }
    
    .error {
      text-align: center;
      padding: 60px 20px;
      color: #da3633;
    }
    
    .sync-notice {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1f6feb;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      animation: fadeIn 0.3s;
      z-index: 1000;
    }
    
    .cache-notice {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #ffa500;
      color: #000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      animation: fadeIn 0.3s;
      z-index: 1000;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    button {
      font-family: inherit;
    }
    
    #lastSync {
      font-size: 11px;
      color: #8b949e;
      text-align: center;
      margin-top: 10px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ —É—á–µ–Ω–∏–∫–æ–≤ */
    .students-container {
      padding: 16px;
    }
    
    .students-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #161b22;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      border: 1px solid #30363d;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .stat-number.total { color: #58a6ff; }
    .stat-number.active { color: #238636; }
    
    .stat-label {
      font-size: 12px;
      color: #8b949e;
    }
    
    .student-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .student-card {
      background: #161b22;
      border-radius: 10px;
      padding: 16px;
      border: 1px solid #30363d;
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .student-name {
      font-weight: bold;
      color: white;
      font-size: 16px;
    }
    
    .student-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: #238636;
      color: white;
    }
    
    .status-paused {
      background: #ffa500;
      color: black;
    }
    
    .student-info {
      color: #8b949e;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .no-students {
      text-align: center;
      padding: 40px 20px;
      color: #8b949e;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="user-info">
        <div class="avatar">üë®‚Äçüè´</div>
        <div>
          <h3 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
          <p>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</p>
        </div>
      </div>
      <button class="refresh-btn" id="refreshBtn" onclick="forceRefresh()">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
    <div id="lastSync"></div>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="showSchedule()">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
    <div class="tab" onclick="showStudents()">–£—á–µ–Ω–∏–∫–∏</div>
    <div class="tab" onclick="showSubjects()">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
  </div>
  
  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#21262d"></div>–ù–µ —Ä–∞–±–æ—Ç–∞—é</div>
    <div class="legend-item"><div class="legend-box" style="background:#238636"></div>–°–≤–æ–±–æ–¥–µ–Ω</div>
    <div class="legend-item"><div class="legend-box" style="background:#da3633"></div>–ó–∞–Ω—è—Ç</div>
  </div>
  
  <div class="content" id="content">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>
  </div>

  <script>
    // Telegram Web App
    if (typeof Telegram !== 'undefined') {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
      if (Telegram.WebApp.isVersionAtLeast('6.1')) {
        Telegram.WebApp.BackButton.show();
        Telegram.WebApp.BackButton.onClick(() => {
          Telegram.WebApp.close();
        });
      }
    }
    
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const DAYS = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    const FULL_DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const TIMES = [];
    for (let h = 8; h <= 22; h++) {
      TIMES.push(`${h.toString().padStart(2, '0')}:00`);
      if (h < 22) TIMES.push(`${h.toString().padStart(2, '0')}:30`);
    }
    const TEXTS = ['–ù–µ —Ä–∞–±–æ—Ç–∞—é', '–°–≤–æ–±–æ–¥–µ–Ω', '–ó–∞–Ω—è—Ç'];
    
    // –î–∞–Ω–Ω—ã–µ
    let schedule = {};
    let currentUser = null;
    let lastScheduleHash = '';
    let isSaving = false;
    let lastUpdateTime = 0;
    const STORAGE_KEY = 'teacher_schedule_v3';
    const CACHE_TTL = 30000;
    
    // ===== –£–¢–ò–õ–ò–¢–´ =====
    
    // –ü–æ–ª—É—á–∏—Ç—å Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getTelegramId() {
      if (typeof Telegram !== 'undefined' && Telegram.WebApp.initDataUnsafe.user) {
        return Telegram.WebApp.initDataUnsafe.user.id.toString();
      }
      // –î–ª—è –¥–µ–±–∞–≥–∞ –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç Telegram
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('tgId') || "913096324";
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö—ç—à–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    function getScheduleHash(sched) {
      let hash = '';
      FULL_DAYS.forEach(day => {
        TIMES.forEach(time => {
          const state = sched[day]?.[time] || 0;
          hash += `${day}-${time}:${state}|`;
        });
      });
      return hash;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
    function saveToCache(data) {
      try {
        const cache = {
          data: data,
          timestamp: Date.now(),
          hash: getScheduleHash(data),
          userId: getTelegramId()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cache));
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à:", e);
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–µ—à–∞
    function loadFromCache() {
      try {
        const cached = localStorage.getItem(STORAGE_KEY);
        if (!cached) return null;
        
        const cache = JSON.parse(cached);
        const now = Date.now();
        const userId = getTelegramId();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–µ—à –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–µ —É—Å—Ç–∞—Ä–µ–ª
        if (cache.userId === userId && now - cache.timestamp < CACHE_TTL) {
          return cache.data;
        }
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –∫–µ—à–∞:", e);
      }
      return null;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotice(text, color = '#1f6feb', duration = 2000) {
      const notice = document.createElement('div');
      notice.className = 'sync-notice';
      notice.style.background = color;
      notice.textContent = text;
      document.body.appendChild(notice);
      
      setTimeout(() => {
        notice.style.opacity = '0';
        notice.style.transform = 'translateY(10px)';
        setTimeout(() => document.body.removeChild(notice), 300);
      }, duration);
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    function updateLastSyncTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('lastSync').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${timeStr}`;
    }
    
    // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUser() {
      try {
        const telegramId = getTelegramId();
        const url = `/api/user?tgId=${telegramId}&t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ ${response.status}`);
        }
        
        const user = await response.json();
        currentUser = user;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if (!user.exists) {
          document.getElementById('userName').textContent = "–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω";
          document.getElementById('content').innerHTML = `
            <div class="error">
              –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.<br><br>
              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram –∏ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.
            </div>
          `;
          return false;
        }
        
        if (user.status !== 'active') {
          document.getElementById('userName').textContent = user.name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
          document.getElementById('content').innerHTML = `
            <div class="error">
              –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.<br><br>
              –°—Ç–∞—Ç—É—Å: ${user.status === 'pending' ? '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ' : '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω'}
            </div>
          `;
          return false;
        }
        
        document.getElementById('userName').textContent = user.name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        return true;
        
      } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
        document.getElementById('userName').textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
        return false;
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    async function loadSchedule(force = false) {
      try {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;
        refreshBtn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
        
        // –ï—Å–ª–∏ –Ω–µ —Ñ–æ—Ä—Å–∏—Ä—É–µ–º –∏ –µ—Å—Ç—å –∫–µ—à - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
        if (!force) {
          const cached = loadFromCache();
          if (cached) {
            schedule = cached;
            renderSchedule();
            showNotice("–î–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞", "#ffa500", 1500);
          }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        const telegramId = getTelegramId();
        const url = `/api/my-schedule?tgId=${telegramId}&t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ ${response.status}`);
        }
        
        const data = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
        const newHash = getScheduleHash(data);
        const shouldUpdate = force || newHash !== lastScheduleHash;
        
        if (shouldUpdate) {
          schedule = data;
          lastScheduleHash = newHash;
          lastUpdateTime = data._timestamp || Date.now();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
          saveToCache(data);
          
          // –†–µ–Ω–¥–µ—Ä–∏–º
          renderSchedule();
          updateLastSyncTime();
          
          if (!force) {
            showNotice("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ");
          }
          
          console.log("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Å–µ—Ä–≤–µ—Ä)");
        } else {
          console.log("‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å");
        }
        
      } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –∫–µ—à –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const cached = loadFromCache();
        if (cached && Object.keys(cached).length > 0) {
          schedule = cached;
          renderSchedule();
          showNotice("–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º (–¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞)", "#ffa500", 3000);
        } else {
          document.getElementById('content').innerHTML = `
            <div class="error">
              –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
              <br>
              <button onclick="forceRefresh()" style="margin-top: 20px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
          `;
        }
      } finally {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
      }
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    async function forceRefresh() {
      showNotice("–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...", "#1f6feb");
      await loadSchedule(true);
    }
    
    // –†–µ–Ω–¥–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    function renderSchedule() {
      if (Object.keys(schedule).length === 0) {
        document.getElementById('content').innerHTML = `
          <div class="loading">
            –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —è—á–µ–π–∫–∏, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å.
          </div>
        `;
        return;
      }
      
      let html = '<div class="week-header"><div></div>';
      DAYS.forEach(d => html += `<div class="day-name">${d}</div>`);
      html += '</div>';
      
      TIMES.forEach(time => {
        html += `<div class="time-row"><div class="time-label">${time}</div><div class="slots">`;
        DAYS.forEach((_, i) => {
          const day = FULL_DAYS[i];
          const state = schedule[day]?.[time] || 0;
          html += `<div class="slot state-${state}" onclick="toggleSlot('${day}', '${time}', this)">
            <div class="slot-time">${time}</div>
            <div>${TEXTS[state]}</div>
          </div>`;
        });
        html += '</div></div>';
      });
      
      document.getElementById('content').innerHTML = html;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏
    async function toggleSlot(day, time, element) {
      if (isSaving) {
        showNotice("–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", "#ffa500", 1000);
        return;
      }
      
      isSaving = true;
      
      try {
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (!schedule[day]) schedule[day] = {};
        const current = schedule[day][time] || 0;
        const next = (current + 1) % 3;
        schedule[day][time] = next;
        
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        element.className = `slot state-${next}`;
        element.querySelector('div:last-child').textContent = TEXTS[next];
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à —Å—Ä–∞–∑—É
        saveToCache(schedule);
        lastScheduleHash = getScheduleHash(schedule);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const telegramId = getTelegramId();
        const response = await fetch(`/api/schedule/${telegramId}?t=${Date.now()}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(schedule)
        });
        
        const result = await response.json();
        if (result.ok) {
          showNotice("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "#238636", 1000);
          lastUpdateTime = result._timestamp || Date.now();
          updateLastSyncTime();
        }
        
      } catch (saveError) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", saveError);
        showNotice("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "#da3633", 2000);
      } finally {
        isSaving = false;
      }
    }
    
    // –í–∫–ª–∞–¥–∫–∏
    function showSchedule() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[0].classList.add('active');
      loadSchedule();
    }
    
    async function showStudents() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[1].classList.add('active');
      
      document.getElementById('content').innerHTML = `
        <div class="students-container">
          <div class="students-stats">
            <div class="stat-card">
              <div class="stat-number total" id="totalStudents">0</div>
              <div class="stat-label">–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤</div>
            </div>
            <div class="stat-card">
              <div class="stat-number active" id="activeStudents">0</div>
              <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
          </div>
          <div id="studentsList">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...</div>
          </div>
        </div>
      `;
      
      await loadStudents();
    }
    
    async function loadStudents() {
      try {
        const telegramId = getTelegramId();
        const response = await fetch(`/api/students/${telegramId}?t=${Date.now()}`);
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤');
        }
        
        const data = await response.json();
        
        document.getElementById('totalStudents').textContent = data.total || 0;
        document.getElementById('activeStudents').textContent = data.active || 0;
        
        if (data.students.length === 0) {
          document.getElementById('studentsList').innerHTML = `
            <div class="no-students">
              –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤
            </div>
          `;
          return;
        }
        
        let html = '<div class="student-list">';
        
        data.students.forEach(student => {
          const statusClass = student.status === 'active' ? 'status-active' : 'status-paused';
          const statusText = student.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–∞ –ø–∞—É–∑–µ';
          
          html += `
            <div class="student-card">
              <div class="student-header">
                <div class="student-name">${student.full_name}</div>
                <div class="student-status ${statusClass}">${statusText}</div>
              </div>
              <div class="student-info">
                <span>–ö–ª–∞—Å—Å: ${student.class || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                <span>–ü—Ä–µ–¥–º–µ—Ç: ${student.subject || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        document.getElementById('studentsList').innerHTML = html;
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤:', error);
        document.getElementById('studentsList').innerHTML = `
          <div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤</div>
        `;
      }
    }
    
    function showSubjects() {
      const telegramId = getTelegramId();
      window.location.href = `/subjects.html?tgId=${telegramId}`;
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    function startAutoSync() {
      setInterval(async () => {
        if (!isSaving && document.visibilityState === 'visible') {
          console.log("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π");
          await loadSchedule();
        }
      }, 60000);
      
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log("üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
          loadSchedule();
        }
      });
    }
    
    // ===== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
    
    async function init() {
      console.log("üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
      
      // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userLoaded = await loadUser();
      if (!userLoaded) return;
      
      // –ó–∞—Ç–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
      await loadSchedule(true);
      startAutoSync();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
      setInterval(updateLastSyncTime, 60000);
      
      console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ");
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.forceRefresh = forceRefresh;
    window.showSchedule = showSchedule;
    window.showStudents = showStudents;
    window.showSubjects = showSubjects;
    window.toggleSlot = toggleSlot;
  </script>
</body>
</html>
