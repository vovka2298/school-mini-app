<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Расписание</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; background:#000; color:#fff; font-family:Arial; }
    .header { background:#111; padding:15px; text-align:center; font-size:18px; }
    .tabs { display:flex; background:#222; }
    .tab { flex:1; padding:15px; text-align:center; background:#333; }
    .tab.active { background:#2481cc; }
    .grid { padding:10px; }
    .row { display:flex; margin:2px 0; }
    .time { width:60px; font-size:12px; color:#aaa; }
    .days { display:flex; flex:1; }
    .slot { flex:1; height:40px; margin:0 2px; background:#333; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .free { background:#0f0 !important; }
    .busy { background:#ff0 !important; color:#000; }
  </style>
</head>
<body>
  <div class="header" id="name">Загрузка...</div>
  <div class="tabs">
    <div class="tab active" onclick="tab=0;render()">Расписание</div>
    <div class="tab" onclick="tab=1;render()">Заявки</div>
    <div class="tab" onclick="tab=2;render()">Предметы</div>
  </div>
  <div class="grid" id="grid"></div>

  <script>
    let me = null;
    let all = {};
    let tab = 0;
    const days = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
    const times = [];
    for(let h=8;h<=22;h++) {
      times.push(h+":00");
      if(h<22) times.push(h+":30");
    }

    async function init() {
      try {
        const u = await fetch('/api/user').then(r=>r.json());
        if(!u.role) return alert("Доступ запрещён");
        me = u;
        document.getElementById('name').innerText = u.name;
        all = await fetch('/api/schedules').then(r=>r.json());
        render();
      } catch { alert("Ошибка сети"); }
    }

    function render() {
      if(tab!==0) { document.getElementById('grid').innerHTML="<p style='text-align:center;padding:50px'>В разработке</p>"; return; }
      let html = '';
      times.forEach(t => {
        html += `<div class="row"><div class="time">${t}</div><div class="days">`;
        days.forEach(d => {
          const dayKey = ["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"][days.indexOf(d)];
          const state = all[me.tgId]?.[dayKey]?.[t] || 0;
          const cls = state===1 ? 'free' : state===2 ? 'busy' : '';
          html += `<div class="slot ${cls}" onclick="toggle('${dayKey}','${t}')"></div>`;
        });
        html += '</div></div>';
      });
      document.getElementById('grid').innerHTML = html;
    }

    async function toggle(day, time) {
      const current = all[me.tgId]?.[day]?.[time] || 0;
      const next = (current + 1) % 3;
      const update = { [day]: { ...all[me.tgId][day], [time]: next } };
      await fetch(`/api/schedule/${me.tgId}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(update)});
      all[me.tgId] = { ...all[me.tgId], ...update };
      render();
    }

    init();
  </script>
</body>
</html>
