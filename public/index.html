<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .header {
      background: #161b22;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid #30363d;
    }
    
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid #58a6ff;
      background: #21262d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .tabs {
      display: flex;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }
    
    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .tab.active {
      background: #1f6feb;
      color: white;
    }
    
    .legend {
      padding: 14px;
      background: #161b22;
      display: flex;
      justify-content: center;
      gap: 24px;
      font-size: 13px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 6px;
    }
    
    .content {
      padding: 12px;
      height: calc(100vh - 235px);
      overflow-y: auto;
    }
    
    .week-header {
      display: flex;
      margin-left: 68px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #8b949e;
    }
    
    .day-name {
      width: 88px;
      text-align: center;
      flex: none;
    }
    
    .time-row {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    
    .time-label {
      width: 68px;
      text-align: right;
      font-size: 13px;
      color: #8b949e;
      padding-right: 12px;
      flex: none;
    }
    
    .slots {
      display: flex;
      flex: 1;
    }
    
    .slot {
      width: 80px;
      height: 56px;
      margin: 0 4px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
    }
    
    .state-0 { background: #21262d; color: #8b949e; }
    .state-1 { background: #238636; color: white; }
    .state-2 { background: #da3633; color: white; }
    
    .slot-time {
      font-size: 9px;
      opacity: 0.8;
      margin-bottom: 3px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
    }
    
    .error {
      text-align: center;
      padding: 60px 20px;
      color: #da3633;
    }
    
    button {
      background: #1f6feb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    
    button:hover {
      background: #1565c0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar">üë®‚Äçüè´</div>
    <div>
      <h3 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
      <p>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</p>
    </div>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="showSchedule()">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
    <div class="tab" onclick="showBookings()">–ó–∞—è–≤–∫–∏</div>
    <div class="tab" onclick="showSubjects()">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
  </div>
  
  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#21262d"></div>–ù–µ —Ä–∞–±–æ—Ç–∞—é</div>
    <div class="legend-item"><div class="legend-box" style="background:#238636"></div>–°–≤–æ–±–æ–¥–µ–Ω</div>
    <div class="legend-item"><div class="legend-box" style="background:#da3633"></div>–ó–∞–Ω—è—Ç</div>
  </div>
  
  <div class="content" id="content">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>
  </div>

  <script>
    // Telegram Web App
    if (typeof Telegram !== 'undefined') {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
    
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const DAYS = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    const FULL_DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const TIMES = [];
    for (let h = 8; h <= 22; h++) {
      TIMES.push(`${h.toString().padStart(2, '0')}:00`);
      if (h < 22) TIMES.push(`${h.toString().padStart(2, '0')}:30`);
    }
    const TEXTS = ['–ù–µ —Ä–∞–±–æ—Ç–∞—é', '–°–≤–æ–±–æ–¥–µ–Ω', '–ó–∞–Ω—è—Ç'];
    
    // –î–∞–Ω–Ω—ã–µ
    let schedule = {};
    const MY_ID = "913096324";
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    async function loadSchedule() {
      try {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...");
        const response = await fetch('/api/my-schedule');
        const data = await response.json();
        schedule = data;
        console.log("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:", schedule);
        renderSchedule();
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞:", error);
        document.getElementById('content').innerHTML = `
          <div class="error">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            <br>
            <button onclick="loadSchedule()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          </div>
        `;
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    function renderSchedule() {
      let html = '<div class="week-header"><div></div>';
      DAYS.forEach(d => html += `<div class="day-name">${d}</div>`);
      html += '</div>';
      
      TIMES.forEach(time => {
        html += `<div class="time-row"><div class="time-label">${time}</div><div class="slots">`;
        DAYS.forEach((_, i) => {
          const day = FULL_DAYS[i];
          const state = schedule[day]?.[time] || 0;
          html += `<div class="slot state-${state}" onclick="toggleSlot('${day}', '${time}')">
            <div class="slot-time">${time}</div>
            <div>${TEXTS[state]}</div>
          </div>`;
        });
        html += '</div></div>';
      });
      
      document.getElementById('content').innerHTML = html;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏
    async function toggleSlot(day, time) {
      if (!schedule[day]) schedule[day] = {};
      const current = schedule[day][time] || 0;
      const next = (current + 1) % 3;
      schedule[day][time] = next;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      renderSchedule();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º
      try {
        await fetch(`/api/schedule/${MY_ID}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(schedule)
        });
        console.log("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:", day, time, "=", next);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
      }
    }
    
    // –í–∫–ª–∞–¥–∫–∏
    function showSchedule() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[0].classList.add('active');
      loadSchedule();
    }
    
    function showBookings() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[1].classList.add('active');
      document.getElementById('content').innerHTML = `
        <div class="loading">
          –†–∞–∑–¥–µ–ª "–ó–∞—è–≤–∫–∏" —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
        </div>
      `;
    }
    
    function showSubjects() {
      window.location.href = '/subjects.html';
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUser() {
      try {
        const response = await fetch('/api/user');
        const user = await response.json();
        document.getElementById('userName').textContent = user.name || "–í–ª–∞–¥–∏–º–∏—Ä";
      } catch (error) {
        document.getElementById('userName').textContent = "–í–ª–∞–¥–∏–º–∏—Ä";
      }
    }
    
    // –ó–∞–ø—É—Å–∫
    window.onload = function() {
      loadUser();
      loadSchedule();
    };
  </script>
</body>
</html>
