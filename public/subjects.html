const express = require('express');
const { Redis } = require('@upstash/redis');
const path = require('path');

const app = express();
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Upstash
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL || "https://us1-perfect-bream-38700.upstash.io",
  token: process.env.UPSTASH_REDIS_REST_TOKEN || "AYa7ASQgY2U1MmM0MjItZTY3Mi00OWY1LWI5MGUtMDg2OTc2NDg1MGYwYjQ3MTExYmIyNWRmZGI4NzE2MzY1MTFmYzFiM2EzYWE="
});

// === –î–ê–ù–ù–´–ï ===
async function getData(key, defaultValue) {
  try {
    const value = await redis.get(key);
    console.log(`–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ Redis –¥–ª—è –∫–ª—é—á–∞ "${key}":`, value ? "–¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å" : "–ø—É—Å—Ç–æ");
    if (value) return value;
  } catch (e) {
    console.log("–û—à–∏–±–∫–∞ get –¥–ª—è –∫–ª—é—á–∞", key, ":", e.message);
  }
  return defaultValue;
}

async function setData(key, value) {
  try {
    console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –∫–ª—é—á "${key}":`, typeof value === 'object' ? `–æ–±—ä–µ–∫—Ç —Å ${Object.keys(value).length} –∫–ª—é—á–∞–º–∏` : value);
    await redis.set(key, value);
    console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –∫–ª—é—á–∞: "${key}"`);
    return true;
  } catch (e) {
    console.log(`‚ùå –û—à–∏–±–∫–∞ set –¥–ª—è –∫–ª—é—á–∞ "${key}":`, e.message);
    return false;
  }
}

// –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
let users = {};
let schedules = {};
let profiles = {};
let admins = [];

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
async function initializeData() {
  console.log("=== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –î–ê–ù–ù–´–• ===");
  
  try {
    const [usersData, schedulesData, profilesData, adminsData] = await Promise.all([
      getData('users', {}),
      getData('schedules', {}),
      getData('profiles', {}),
      getData('admins', [])
    ]);
    
    users = usersData || {};
    schedules = schedulesData || {};
    profiles = profilesData || {};
    admins = adminsData || [];
    
    console.log("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Redis");
    console.log("üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", Object.keys(users).length);
    console.log("üìä –†–∞—Å–ø–∏—Å–∞–Ω–∏–π:", Object.keys(schedules).length);
    console.log("üìä –ü—Ä–æ—Ñ–∏–ª–µ–π:", Object.keys(profiles).length);
    console.log("üìä –ê–¥–º–∏–Ω–æ–≤:", admins.length);
    
    // –¢–´ ‚Äî –í–ï–ß–ù–´–ô –ê–î–ú–ò–ù
    const eternalAdminId = "913096324";
    console.log(`\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ (ID: ${eternalAdminId})...`);
    
    if (!admins.includes(eternalAdminId)) {
      console.log("üëë –°–æ–∑–¥–∞—é –≤–µ—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞...");
      admins.push(eternalAdminId);
      users[eternalAdminId] = { name: "–í–ª–∞–¥–∏–º–∏—Ä", role: "admin" };
      schedules[eternalAdminId] = schedules[eternalAdminId] || {};
      profiles[eternalAdminId] = { subjects: [], gender: "–ú—É–∂—Å–∫–æ–π" };
      
      console.log("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∞...");
      await Promise.all([
        setData('users', users),
        setData('schedules', schedules),
        setData('profiles', profiles),
        setData('admins', admins)
      ]);
      
      console.log("‚úÖ –í–µ—á–Ω—ã–π –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
    } else {
      console.log("‚úÖ –í–µ—á–Ω—ã–π –∞–¥–º–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
    }
    
    console.log("\n=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê ===\n");
    
  } catch (e) {
    console.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
    console.error("–°—Ç–µ–∫ –æ—à–∏–±–∫–∏:", e.stack);
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
initializeData();

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö
async function saveAllData() {
  try {
    console.log("üíæ –ù–∞—á–∞–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Redis...");
    
    const results = await Promise.allSettled([
      setData('users', users),
      setData('schedules', schedules),
      setData('profiles', profiles),
      setData('admins', admins)
    ]);
    
    console.log("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Redis");
    results.forEach((result, index) => {
      const keys = ['users', 'schedules', 'profiles', 'admins'];
      if (result.status === 'fulfilled') {
        console.log(`  ${keys[index]}: ${result.value ? '‚úÖ' : '‚ùå'}`);
      } else {
        console.log(`  ${keys[index]}: ‚ùå –û—à–∏–±–∫–∞: ${result.reason}`);
      }
    });
    
    return true;
  } catch (e) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
    return false;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
async function saveScheduleData() {
  try {
    console.log("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –≤ Redis...");
    const success = await setData('schedules', schedules);
    if (success) {
      console.log(`‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –í—Å–µ–≥–æ: ${Object.keys(schedules).length}`);
    }
    return success;
  } catch (e) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π:", e);
    return false;
  }
}

// === API ===

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
app.get('/api/user', async (req, res) => {
  const id = "913096324"; // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π ID
  console.log(`üë§ –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: ${id}`);
  
  const user = users[id];
  console.log(`üë§ –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:`, user);
  
  if (!user) {
    console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ`);
    return res.json({ 
      role: null,
      name: "",
      photo: "",
      tgId: id,
      needsApproval: true
    });
  }
  
  const response = {
    role: admins.includes(id) ? 'admin' : 'teacher',
    name: user.name,
    photo: "",
    tgId: id
  };
  
  console.log(`üë§ –û—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${id}:`, response);
  res.json(response);
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤) –∏–ª–∏ —Å–≤–æ–µ–≥–æ (–¥–ª—è —É—á–∏—Ç–µ–ª–µ–π)
app.get('/api/schedules', async (req, res) => {
  const id = "913096324"; // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π ID
  
  console.log(`üìÖ –ó–∞–ø—Ä–æ—Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: ${id}`);
  console.log(`üìÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${!!users[id]}`);
  console.log(`üìÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω: ${admins.includes(id)}`);
  
  if (!users[id]) {
    console.log(`‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω`);
    return res.status(403).json({ error: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –í–°–ï —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –µ—Å–ª–∏ –∞–¥–º–∏–Ω, –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ
  if (admins.includes(id)) {
    console.log(`üìÖ –ê–¥–º–∏–Ω ${id} –∑–∞–ø—Ä–æ—Å–∏–ª –≤—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π (${Object.keys(schedules).length})`);
    res.json(schedules);
  } else {
    console.log(`üìÖ –£—á–∏—Ç–µ–ª—å ${id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`);
    res.json({ [id]: schedules[id] || {} });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¢–û–õ–¨–ö–û —Å–≤–æ–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
app.get('/api/my-schedule', async (req, res) => {
  const id = "913096324"; // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  
  console.log(`üìÖ –ó–∞–ø—Ä–æ—Å –°–í–û–ï–ì–û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ID: ${id}`);
  console.log(`üìÖ –¢–µ–∫—É—â–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏:`, Object.keys(schedules));
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (!schedules[id]) {
    console.log(`üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–µ`);
    schedules[id] = {};
    // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ Redis
    await saveScheduleData();
  }
  
  console.log(`üìÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${id}:`, schedules[id]);
  res.json(schedules[id]);
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
app.post('/api/schedule/:tgId', async (req, res) => {
  const target = req.params.tgId;
  
  console.log(`\nüíæ –ó–ê–ü–†–û–° –ù–ê –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–Ø`);
  console.log(`üíæ –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${target}`);
  console.log(`üíæ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:`, req.body);
  console.log(`üíæ –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:`, typeof req.body);
  
  if (!schedules[target]) {
    console.log(`üíæ –°–æ–∑–¥–∞—é –Ω–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${target}`);
    schedules[target] = {};
  }
  
  // –í–∞–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  // –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–∏—à–ª–æ –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–æ–±—ä–µ–∫—Ç —Å –¥–Ω—è–º–∏)
  if (req.body && typeof req.body === 'object') {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    const keys = Object.keys(req.body);
    const isFullSchedule = keys.some(key => 
      key === '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫' || key === '–í—Ç–æ—Ä–Ω–∏–∫' || key === '–°—Ä–µ–¥–∞' || 
      key === '–ß–µ—Ç–≤–µ—Ä–≥' || key === '–ü—è—Ç–Ω–∏—Ü–∞' || key === '–°—É–±–±–æ—Ç–∞' || key === '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
    );
    
    if (isFullSchedule) {
      // –≠—Ç–æ –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
      console.log(`üíæ –ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –¥–Ω—è–º–∏:`, keys);
      schedules[target] = req.body;
    } else if (req.body.day && req.body.time !== undefined && req.body.state !== undefined) {
      // –≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —è—á–µ–π–∫–∏
      const { day, time, state } = req.body;
      console.log(`üíæ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —è—á–µ–π–∫–∏: ${day} ${time} = ${state}`);
      
      if (!schedules[target][day]) {
        schedules[target][day] = {};
      }
      schedules[target][day][time] = state;
    } else {
      // –ü—ã—Ç–∞–µ–º—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
      console.log(`üíæ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∫–∞–∫ –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`);
      schedules[target] = req.body;
    }
  }
  
  console.log(`üíæ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${target}:`, schedules[target]);
  
  // –°–†–ê–ó–£ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis
  const saveSuccess = await saveScheduleData();
  
  if (saveSuccess) {
    console.log(`‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Redis –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${target}`);
    res.json({ 
      ok: true, 
      message: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
      schedule: schedules[target]
    });
  } else {
    console.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${target}`);
    res.status(500).json({ 
      ok: false, 
      error: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö" 
    });
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
app.get('/api/profile/:tgId', async (req, res) => {
  const tgId = req.params.tgId;
  console.log(`üë§ –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è ID: ${tgId}`);
  
  const profile = profiles[tgId] || { subjects: [], gender: "–ú—É–∂—Å–∫–æ–π" };
  console.log(`üë§ –ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è ${tgId}:`, profile);
  
  res.json(profile);
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
app.post('/api/profile/:tgId', async (req, res) => {
  const tgId = req.params.tgId;
  
  console.log(`\nüíæ –ó–ê–ü–†–û–° –ù–ê –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø`);
  console.log(`üíæ –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${tgId}`);
  console.log(`üíæ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è:`, req.body);
  
  profiles[tgId] = req.body;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ Redis
  const saveSuccess = await setData('profiles', profiles);
  
  if (saveSuccess) {
    console.log(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${tgId}`);
    res.json({ 
      ok: true, 
      message: "–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω"
    });
  } else {
    console.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è ${tgId}`);
    res.status(500).json({ 
      ok: false, 
      error: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è" 
    });
  }
});

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
app.post('/api/approve_user', async (req, res) => {
  const { tgId, name, role } = req.body;
  
  console.log(`\nüëë –ó–ê–ü–†–û–° –ù–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø`);
  console.log(`üëë ID: ${tgId}, –ò–º—è: ${name}, –†–æ–ª—å: ${role}`);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –æ—Ç –∞–¥–º–∏–Ω–∞
  const callerId = "913096324"; // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–ª—É—á–∞–µ–º –∏–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (!admins.includes(callerId)) {
    console.log(`‚ùå –ó–∞–ø—Ä–æ—Å –æ—Ç –Ω–µ-–∞–¥–º–∏–Ω–∞ ${callerId}, –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω`);
    return res.status(403).json({ error: "–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤" });
  }
  
  if (!tgId || !name || !role) {
    console.log(`‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
    return res.status(400).json({ error: "–ù–µ–æ–±—Ö–æ–¥–∏–º—ã tgId, name –∏ role" });
  }
  
  users[tgId] = { name, role };
  
  if (role === 'admin' && !admins.includes(tgId)) {
    admins.push(tgId);
    console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${tgId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω—ã`);
  }
  
  // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–∏–ª—å –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
  schedules[tgId] = schedules[tgId] || {};
  profiles[tgId] = profiles[tgId] || { subjects: [], gender: "–ú—É–∂—Å–∫–æ–π" };
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
  const saveSuccess = await saveAllData();
  
  if (saveSuccess) {
    console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${tgId} —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω`);
    res.json({ 
      ok: true, 
      message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω",
      user: users[tgId]
    });
  } else {
    console.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${tgId}`);
    res.status(500).json({ 
      ok: false, 
      error: "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö" 
    });
  }
});

// –û—Ç–ª–∞–¥–æ—á–Ω—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
app.get('/api/debug', async (req, res) => {
  console.log(`üîç –ó–∞–ø—Ä–æ—Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏`);
  
  const debugInfo = {
    users: {
      count: Object.keys(users).length,
      ids: Object.keys(users)
    },
    schedules: {
      count: Object.keys(schedules).length,
      ids: Object.keys(schedules),
      details: Object.keys(schedules).reduce((acc, id) => {
        const schedule = schedules[id];
        const days = Object.keys(schedule).filter(key => 
          ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'].includes(key)
        );
        acc[id] = {
          days: days.length,
          hasData: days.length > 0
        };
        return acc;
      }, {})
    },
    profiles: {
      count: Object.keys(profiles).length,
      ids: Object.keys(profiles)
    },
    admins: {
      count: admins.length,
      ids: admins
    },
    eternalAdmin: {
      id: "913096324",
      exists: admins.includes("913096324"),
      hasSchedule: !!schedules["913096324"],
      hasProfile: !!profiles["913096324"]
    },
    memory: {
      usersSize: JSON.stringify(users).length,
      schedulesSize: JSON.stringify(schedules).length,
      profilesSize: JSON.stringify(profiles).length
    }
  };
  
  console.log(`üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞`);
  res.json(debugInfo);
});

// Endpoint –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
app.post('/api/force-save', async (req, res) => {
  console.log(`üíæ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï –í–°–ï–• –î–ê–ù–ù–´–•`);
  
  const success = await saveAllData();
  
  if (success) {
    res.json({ 
      ok: true, 
      message: "–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
      stats: {
        users: Object.keys(users).length,
        schedules: Object.keys(schedules).length,
        profiles: Object.keys(profiles).length,
        admins: admins.length
      }
    });
  } else {
    res.status(500).json({ 
      ok: false, 
      error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö" 
    });
  }
});

// –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!)
app.post('/api/reset', async (req, res) => {
  console.log(`‚ö†Ô∏è  –°–ë–†–û–° –í–°–ï–• –î–ê–ù–ù–´–•!`);
  
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
  const eternalAdminId = "913096324";
  
  users = { [eternalAdminId]: { name: "–í–ª–∞–¥–∏–º–∏—Ä", role: "admin" } };
  schedules = { [eternalAdminId]: {} };
  profiles = { [eternalAdminId]: { subjects: [], gender: "–ú—É–∂—Å–∫–æ–π" } };
  admins = [eternalAdminId];
  
  await saveAllData();
  
  res.json({ 
    ok: true, 
    message: "–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã, –≤–µ—á–Ω—ã–π –∞–¥–º–∏–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω",
    eternalAdmin: eternalAdminId
  });
});

app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`
  ==========================================
  üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${port}
  üìÅ –°—Ç–∞—Ç–∏–∫–∞ –∏–∑ –ø–∞–ø–∫–∏: public
  üóÑÔ∏è  Redis: ${redis.url ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}
  üëë –í–µ—á–Ω—ã–π –∞–¥–º–∏–Ω: 913096324
  ==========================================
  `);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  console.log(`\nüîç –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –î–ê–ù–ù–´–•:`);
  console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${Object.keys(users).length}`);
  console.log(`üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏—è: ${Object.keys(schedules).length}`);
  console.log(`üìã –ü—Ä–æ—Ñ–∏–ª–∏: ${Object.keys(profiles).length}`);
  console.log(`üëë –ê–¥–º–∏–Ω—ã: ${admins.length}`);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—á–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
  const eternalAdminId = "913096324";
  console.log(`\nüîç –í–ï–ß–ù–´–ô –ê–î–ú–ò–ù (${eternalAdminId}):`);
  console.log(`   –í –∞–¥–º–∏–Ω–∞—Ö: ${admins.includes(eternalAdminId) ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`);
  console.log(`   –ï—Å—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${schedules[eternalAdminId] ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`);
  console.log(`   –ï—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—å: ${profiles[eternalAdminId] ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`);
  
  console.log(`\nüåê –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:`);
  console.log(`   GET  /api/user - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
  console.log(`   GET  /api/my-schedule - —Å–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`);
  console.log(`   GET  /api/schedules - –≤—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–∞)`);
  console.log(`   POST /api/schedule/:tgId - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`);
  console.log(`   GET  /api/profile/:tgId - –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å`);
  console.log(`   POST /api/profile/:tgId - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å`);
  console.log(`   GET  /api/debug - –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è`);
  console.log(`   POST /api/force-save - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ`);
  console.log(`\nüìÑ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: http://localhost:${port}/test.html`);
  console.log(`==========================================\n`);
});
