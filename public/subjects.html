<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      min-height: 100vh;
    }
    
    .back-btn {
      background: #21262d;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    
    .back-btn:hover {
      background: #30363d;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: white;
    }
    
    .subtitle {
      color: #8b949e;
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .card {
      background: #161b22;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #30363d;
    }
    
    .section-title {
      font-size: 16px;
      margin-bottom: 16px;
      color: #c9d1d9;
      font-weight: 600;
    }
    
    .subjects-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 24px;
    }
    
    .subject-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #21262d;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .subject-item:hover {
      background: #30363d;
      border-color: #58a6ff;
    }
    
    .subject-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #1f6feb;
    }
    
    .subject-name {
      font-size: 14px;
      flex: 1;
    }
    
    .gender-section {
      margin: 24px 0;
      padding: 20px;
      background: #21262d;
      border-radius: 8px;
    }
    
    .gender-options {
      display: flex;
      gap: 30px;
      margin-top: 15px;
    }
    
    .gender-option {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 10px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    
    .gender-option:hover {
      background: #30363d;
    }
    
    .gender-option input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #1f6feb;
    }
    
    .save-btn {
      background: #1f6feb;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      width: 100%;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
    }
    
    .save-btn:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }
    
    .save-btn:active {
      transform: translateY(0);
    }
    
    .save-btn:disabled {
      background: #30363d;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    
    .notice {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #238636;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      animation: slideIn 0.3s;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="window.location.href='/'">
      <span style="font-size: 18px;">‚Üê</span>
      –ù–∞–∑–∞–¥ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
    </button>
    
    <h1>–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h1>
    <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø—Ä–µ–ø–æ–¥–∞–µ—Ç–µ</p>
    
    <div class="card">
      <div class="section-title">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
      <div id="subjectsList" class="loading">
        –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...
      </div>
    </div>
    
    <div class="card">
      <div class="section-title">–ü–æ–ª</div>
      <div class="gender-options">
        <label class="gender-option">
          <input type="radio" name="gender" value="–ú—É–∂—Å–∫–æ–π">
          <span>–ú—É–∂—Å–∫–æ–π</span>
        </label>
        <label class="gender-option">
          <input type="radio" name="gender" value="–ñ–µ–Ω—Å–∫–∏–π">
          <span>–ñ–µ–Ω—Å–∫–∏–π</span>
        </label>
      </div>
    </div>
    
    <button class="save-btn" id="saveBtn" onclick="saveProfile()">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
    const SUPABASE_URL = 'https://rtywenfvaoxsjdkulmdk.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_WhiVd5day72hRoTKiFtiIQ_sP2wu4_S';
    
    // –î–∞–Ω–Ω—ã–µ
    let profile = {
      subjects: [],
      gender: "–ú—É–∂—Å–∫–æ–π"
    };
    let currentUser = null;
    let isSaving = false;
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotice(message, type = 'success') {
      const colors = {
        success: '#238636',
        error: '#da3633',
        info: '#1f6feb'
      };
      
      const notice = document.createElement('div');
      notice.className = 'notice';
      notice.style.background = colors[type] || colors.info;
      notice.textContent = message;
      document.body.appendChild(notice);
      
      setTimeout(() => {
        notice.style.opacity = '0';
        notice.style.transform = 'translateX(100px)';
        setTimeout(() => document.body.removeChild(notice), 300);
      }, 2000);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUser() {
      try {
        // –ü–æ–ª—É—á–∞–µ–º Telegram ID
        let tgId = '913096324';
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('tgId')) tgId = urlParams.get('tgId');
        
        // –ó–∞–ø—Ä–æ—Å –∫ Supabase
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${tgId}&select=*`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            }
          }
        );
        
        if (response.ok) {
          const users = await response.json();
          if (users && users.length > 0) {
            currentUser = users[0];
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:', currentUser);
            return true;
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      }
      return false;
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
    async function loadProfile() {
      try {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...");
        
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userLoaded = await loadUser();
        if (!userLoaded) {
          showNotice("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");
          return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –±–∞–∑—ã
        await loadSubjectsFromDB();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª
        document.querySelectorAll('input[name="gender"]').forEach(radio => {
          radio.checked = radio.value === profile.gender;
        });
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
        showNotice("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è", "error");
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ Supabase
    async function loadSubjectsFromDB() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/subjects?select=*&order=name.asc`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            }
          }
        );
        
        if (response.ok) {
          const subjects = await response.json();
          console.log("–ü—Ä–µ–¥–º–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã:", subjects);
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–µ–¥–º–µ—Ç—ã
          renderSubjects(subjects);
          
        } else {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤');
        }
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:", error);
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫
        const defaultSubjects = [
          "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ë–∞–∑–∞", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–û–ì–≠", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ï–ì–≠", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞5_8", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞9_11",
          "–§–∏–∑–∏–∫–∞5_8", "–§–∏–∑–∏–∫–∞–û–ì–≠", "–§–∏–∑–∏–∫–∞–ï–ì–≠", "–§–∏–∑–∏–∫–∞9_11", "–í—ã—Å—à–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–û–ª–∏–º–ø–∏–∞–¥–∞",
          "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–•–∏–º–∏—è", "–ë–∏–æ–ª–æ–≥–∏—è", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫",
          "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", "–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ", "–ò—Å—Ç–æ—Ä–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è"
        ];
        
        const subjects = defaultSubjects.map(name => ({ name }));
        renderSubjects(subjects);
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    function renderSubjects(subjects) {
      const container = document.getElementById('subjectsList');
      
      if (!container) return;
      
      const html = `
        <div class="subjects-grid">
          ${subjects.map(subject => {
            const isChecked = profile.subjects.includes(subject.name);
            const displayName = subject.name.replace(/_/g, ' ');
            
            return `
              <label class="subject-item">
                <input type="checkbox" 
                       ${isChecked ? 'checked' : ''}
                       onchange="toggleSubject('${subject.name}', this.checked)">
                <span class="subject-name">${displayName}</span>
              </label>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    function toggleSubject(subject, isChecked) {
      console.log(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ ${subject}: ${isChecked}`);
      
      if (isChecked && !profile.subjects.includes(subject)) {
        profile.subjects.push(subject);
      } else if (!isChecked) {
        profile.subjects = profile.subjects.filter(s => s !== subject);
      }
      
      console.log("–¢–µ–∫—É—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã:", profile.subjects);
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    async function saveProfile() {
      if (isSaving || !currentUser) return;
      
      isSaving = true;
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      saveBtn.disabled = true;
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª
        const genderRadio = document.querySelector('input[name="gender"]:checked');
        if (genderRadio) {
          profile.gender = genderRadio.value;
        }
        
        console.log("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:", profile);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É users (–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è subjects –∏ gender)
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/users?id=eq.${currentUser.id}`,
          {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify({
              subjects: profile.subjects,
              gender: profile.gender,
              updated_at: new Date().toISOString()
            })
          }
        );
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
        
        const result = await response.json();
        console.log("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:", result);
        
        showNotice("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!", "success");
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
          window.location.href = `/?tgId=${currentUser.telegram_id}`;
        }, 1000);
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error);
        showNotice("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è", "error");
      } finally {
        isSaving = false;
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadProfile);
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.toggleSubject = toggleSubject;
    window.saveProfile = saveProfile;
  </script>
</body>
</html>
