const SUBJECTS = [
  "МатематикаБаза", "МатематикаОГЭ", "МатематикаЕГЭ", "Математика5_8", "Математика9_11",
  "Физика5_8", "ФизикаОГЭ", "ФизикаЕГЭ", "Физика9_11", "Высшая математика", "Олимпиада",
  "Информатика", "Программирование", "Химия", "Биология", "Русский язык", "Английский язык",
  "Обществознание", "История", "География"
];

let profile = { subjects: [], gender: "Мужской" };

function getTgId() {
  try {
    return Telegram.WebApp.initDataUnsafe.user.id.toString();
  } catch (e) {
    console.error("Не удалось получить tgId");
    return null;
  }
}

function getAuthHeaders() {
  return {
    'x-telegram-webapp-init-data': Telegram.WebApp.initData || ''
  };
}

async function loadProfile() {
  const tgId = getTgId();
  if (!tgId) {
    if (document.getElementById('subjectsList')) {
      document.getElementById('subjectsList').innerHTML = "<p style='color:#f85149'>Ошибка авторизации (не в Telegram?)</p>";
    }
    return;
  }

  try {
    const response = await fetch(`/api/profile/${tgId}`, { headers: getAuthHeaders() });
    if (response.ok) {
      const data = await response.json();
      profile = { ...profile, ...data };
    }
  } catch (e) {
    console.warn("Не удалось загрузить профиль", e);
  }

  // Устанавливаем gender (теперь после DOM)
  const genderRadio = document.querySelector(`input[name="gender"][value="${profile.gender}"]`);
  if (genderRadio) {
    genderRadio.checked = true;
  } else {
    console.error('Gender radios not found');
  }

  const list = document.getElementById('subjectsList');
  if (list) {
    list.innerHTML = SUBJECTS.map(sub => {
      const checked = profile.subjects.includes(sub) ? 'checked' : '';
      const displayName = sub.replace(/_/g, ' ');
      return `
        <label class="checkbox-item">
          <input type="checkbox" ${checked} onchange="toggleSubject('${sub}', this.checked)">
          <span>${displayName}</span>
        </label>
      `;
    }).join('');
  } else {
    console.error('subjectsList not found');
  }
}

function toggleSubject(subject, isChecked) {
  if (isChecked && !profile.subjects.includes(subject)) {
    profile.subjects.push(subject);
  } else if (!isChecked) {
    profile.subjects = profile.subjects.filter(s => s !== subject);
  }
}

async function saveProfile() {
  const tgId = getTgId();
  if (!tgId) {
    Telegram.WebApp.showAlert("Ошибка ID");
    return;
  }

  const genderInput = document.querySelector('input[name="gender"]:checked');
  if (genderInput) {
    profile.gender = genderInput.value;
  }

  try {
    const response = await fetch(`/api/profile/${tgId}`, {
      method: 'POST',
      headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify(profile)
    });
    if (response.ok) {
      Telegram.WebApp.showAlert("Сохранено!");
    } else {
      Telegram.WebApp.showAlert("Ошибка сохранения.");
    }
  } catch (e) {
    Telegram.WebApp.showAlert("Нет соединения.");
  }
}
