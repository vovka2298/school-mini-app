const SUBJECTS = [
  "МатематикаБаза","МатематикаОГЭ","МатематикаЕГЭ","Математика5_8","Математика9_11",
  "Физика5_8","ФизикаОГЭ","ФизикаЕГЭ","Физика9_11","Высшая математика","Олимпиада",
  "Информатика","Программирование","Химия","Биология","Русский язык",
  "Английский язык","Обществознание","История","География"
];

let profile = { subjects: [], gender: "Мужской" };

function getTgId() {
  try { return Telegram.WebApp.initDataUnsafe.user.id.toString(); }
  catch { return null; }
}

function getHeaders() {
  return { 'x-telegram-webapp-init-data': Telegram.WebApp.initData || '' };
}

async function loadProfile() {
  const tgId = getTgId();
  if (!tgId) return;

  try {
    const res = await fetch(`/api/profile/${tgId}`, { headers: getHeaders() });
    if (res.ok) {
      const data = await res.json();
      profile = { ...profile, ...data };
    }
  } catch (e) { console.warn(e); }

  // Пол
  const radio = document.querySelector(`input[name="gender"][value="${profile.gender}"]`);
  if (radio) radio.checked = true;

  // Предметы
  const list = document.getElementById('subjectsList');
  if (list) {
    list.innerHTML = SUBJECTS.map(s => {
      const checked = profile.subjects.includes(s) ? 'checked' : '';
      return `<label class="checkbox-item">
        <input type="checkbox" ${checked} onchange="toggleSubject('${s}', this.checked)">
        <span>${s.replace(/_/g, ' ')}</span>
      </label>`;
    }).join('');
  }
}

function toggleSubject(sub, checked) {
  if (checked && !profile.subjects.includes(sub)) profile.subjects.push(sub);
  if (!checked) profile.subjects = profile.subjects.filter(x => x !== sub);
}

async function saveProfile() {
  const tgId = getTgId();
  if (!tgId) return Telegram.WebApp.showAlert("Ошибка ID");

  const gender = document.querySelector('input[name="gender"]:checked');
  if (gender) profile.gender = gender.value;

  try {
    const res = await fetch(`/api/profile/${tgId}`, {
      method: 'POST',
      headers: { ...getHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify(profile)
    });
    if (res.ok) {
      Telegram.WebApp.showAlert("Сохранено!");
    } else {
      Telegram.WebApp.showAlert("Ошибка сохранения");
    }
  } catch (e) {
    Telegram.WebApp.showAlert("Нет сети");
  }
}
